const express = require('express');
const axios = require('axios');
const cors = require('cors');
const crypto = require('crypto');
const nodemailer = require('nodemailer');
const { google } = require('googleapis');
const { initializeApp, cert } = require('firebase-admin/app');
const serviceAccount = {
  type: process.env.FIREBASE_TYPE,
  project_id: process.env.FIREBASE_PROJECT_ID,
  private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
  private_key: process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n'),
  client_email: process.env.FIREBASE_CLIENT_EMAIL,
  client_id: process.env.FIREBASE_CLIENT_ID,
  auth_uri: process.env.FIREBASE_AUTH_URI,
  token_uri: process.env.FIREBASE_TOKEN_URI,
  auth_provider_x509_cert_url: process.env.FIREBASE_AUTH_PROVIDER_X509_CERT_URL,
  client_x509_cert_url: process.env.FIREBASE_CLIENT_X509_CERT_URL,
};

initializeApp({
  credential: cert(serviceAccount),
});
const { getFirestore } = require('firebase-admin/firestore');
const path = require('path');
const fs = require('fs');
require('dotenv').config();

const app = express();
app.use(cors());
app.use(express.json());

const PORT = process.env.PORT || 3000;

// Loga as vari√°veis pra garantir que t√£o chegando no ambiente de deploy
console.log('CLIENT_ID:', process.env.CLIENT_ID ? '‚úîÔ∏è set' : '‚ùå missing');
console.log('MPESA_TOKEN:', process.env.MPESA_TOKEN ? '‚úîÔ∏è set' : '‚ùå missing');

// Fun√ß√£o SHA256 (j√° tem no seu c√≥digo)
function sha256(input) {
  return crypto.createHash('sha256').update(input).digest('hex');
}

// --- CONFIGURA√á√ÉO DO NODEMAILER (colocar aqui, junto das imports) ---
const transporter = nodemailer.createTransporter({
  service: 'gmail',
  auth: {
    user: process.env.EMAIL_USER,         // coloca seu email no .env, ex: EMAIL_USER=seu-email@gmail.com
    pass: process.env.EMAIL_PASS_APP,     // senha de app do Gmail no .env, ex: EMAIL_PASS_APP=xxxxxx
  },
});

// Fun√ß√£o para enviar email
function enviarEmail(destino, assunto, conteudoHTML) {
  const transporter = nodemailer.createTransporter({
    service: 'gmail',
    auth: {
      user: process.env.EMAIL_USER,
      pass: process.env.EMAIL_PASS_APP,
    },
  });

  const mailOptions = {
    from: process.env.EMAIL_USER,
    to: destino,
    subject: assunto,
    html: conteudoHTML,
  };

  transporter.sendMail(mailOptions, (erro, info) => {
    if (erro) {
      console.error('‚ùå Erro ao enviar email:', erro);
    } else {
      console.log('üìß Email enviado com sucesso:', info.response);
    }
  });
}

async function notificarPushcutSecundario() {
  try {
    await axios.post('https://api.pushcut.io/q-XmBT8fFsxnWbOyfaBQH/notifications/Venda%20Realizada');
    console.log('‚úÖ Segundo Pushcut enviado');
  } catch (err) {
    console.error('‚ùå Erro ao enviar segundo Pushcut:', err.response?.data || err.message);
  }
}

async function adicionarNaPlanilha({ nome, email, phone, metodo, amount, reference,utm_source,utm_medium,utm_campaign,utm_term,utm_content }) {
  // Parse do JSON das credenciais direto da vari√°vel de ambiente
  const credentials = JSON.parse(process.env.GOOGLE_CREDENTIALS);

  const auth = new google.auth.GoogleAuth({
    credentials,
    scopes: ['https://www.googleapis.com/auth/spreadsheets'],
  });

  const sheets = google.sheets({ version: 'v4', auth: await auth.getClient() });

  const spreadsheetId = '1aVQxptqsfoBnLmgury1UdiYlRGBNrwBz7s3-HC9a_bM'; // substitua pelo ID da sua planilha

  const dataAtual = new Date().toLocaleString('pt-BR', { timeZone: 'Africa/Maputo' });

  const novaLinha = [[nome, email, phone, metodo, amount, reference, dataAtual,utm_source,utm_medium,utm_campaign,utm_term,utm_content]];

  await sheets.spreadsheets.values.append({
    spreadsheetId,
    range: 'A1',
    valueInputOption: 'RAW',
    insertDataOption: 'INSERT_ROWS',
    requestBody: {
      values: novaLinha,
    },
  });

  console.log('üìä Dados adicionados na planilha');
}
const db = getFirestore();

async function notificarPushcut() {
  try {
    await axios.post('https://api.pushcut.io/q-XmBT8fFsxnWbOyfaBQH/notifications/Venda%20Realizada');
    console.log('‚úÖ Pushcut enviado');
  } catch (err) {
    console.error('‚ùå Erro ao enviar Pushcut:', err.response?.data || err.message);
  }
}

// üéØ FUN√á√ïES UTMIFY - ATUALIZADAS PARA USAR ORDERID
async function enviarEventoUtmify(dadosEvento) {
  try {
    const response = await axios.post(
      'https://api.utmify.com.br/api-credentials/orders',
      dadosEvento,
      {
        headers: {
          'x-api-token': 'GScaqKrzCBdQ2IqCrJX5xusXm1lva5iTxR7k',
          'Content-Type': 'application/json',
        },
      }
    );

    console.log('‚úÖ Evento enviado para Utmify:', dadosEvento.status, 'OrderID:', dadosEvento.orderId);
    return response.data;
  } catch (err) {
    console.error('‚ùå Erro ao enviar evento para Utmify:', err.response?.data || err.message);
    throw err;
  }
}

async function criarEventoPagamentoPendente({ orderId, nome, email, phone, amount, utm_source, utm_medium, utm_campaign, utm_term, utm_content }) {
  // Verificar se j√° existe evento pendente para este telefone
  const eventoExistente = await db.collection('utmify_eventos')
    .where('phone', '==', phone)
    .where('status', '==', 'waiting_payment')
    .get();

  if (!eventoExistente.empty) {
    console.log('‚ö†Ô∏è J√° existe evento pendente para este telefone, n√£o enviando duplicado');
    return eventoExistente.docs[0].data().orderId;
  }

  const agora = new Date();
  
  // üéØ CONVERS√ÉO MZN PARA USD (dividir por 64)
  const valorMZN = parseInt(amount);
  const valorUSD = Math.round((valorMZN / 64) * 100); // em centavos USD
  const taxaGateway = Math.round(valorUSD * 0.07); // 7% de taxa
  const comissaoUsuario = valorUSD - taxaGateway; // restante ap√≥s taxa
  
  const dadosEvento = {
    orderId, // üéØ USA O ORDERID √öNICO DO CHECKOUT
    platform: "VisionPay",
    paymentMethod: "pix",
    status: "waiting_payment",
    createdAt: agora.toISOString().replace('T', ' ').substring(0, 19),
    approvedDate: null,
    refundedAt: null,
    customer: {
      name: nome || "Cliente",
      email: email || "cliente@exemplo.com",
      phone: phone,
      document: null,
      country: "MZ",
      ip: "102.0.0.1"
    },
    products: [{
      id: "lifeboost-secrets",
      name: "LifeBoost Secrets",
      planId: null,
      planName: null,
      quantity: 1,
      priceInCents: valorUSD
    }],
    trackingParameters: {
      utm_source: utm_source || null,
      utm_campaign: utm_campaign || null,
      utm_medium: utm_medium || null,
      utm_content: utm_content || null,
      utm_term: utm_term || null,
      src: null,
      sck: null
    },
    commission: {
      totalPriceInCents: valorUSD,
      gatewayFeeInCents: taxaGateway, // 7% de taxa
      userCommissionInCents: comissaoUsuario, // 93% comiss√£o
      currency: "USD"
    },
    isTest: false
  };

  await enviarEventoUtmify(dadosEvento);

  // Salvar no Firebase para controle
  await db.collection('utmify_eventos').add({
    orderId,
    phone,
    status: 'waiting_payment',
    created_at: agora,
  });

  console.log(`üí± Convers√£o: ${valorMZN} MZN ‚Üí ${(valorUSD/100).toFixed(2)} USD`);
  return orderId;
}

async function criarEventoPagamentoAprovado({ orderId, nome, email, phone, amount, utm_source, utm_medium, utm_campaign, utm_term, utm_content }) {
  const agora = new Date();
  
  // üéØ CONVERS√ÉO MZN PARA USD (dividir por 64)
  const valorMZN = parseInt(amount);
  const valorUSD = Math.round((valorMZN / 64) * 100); // em centavos USD
  const taxaGateway = Math.round(valorUSD * 0.07); // 7% de taxa
  const comissaoUsuario = valorUSD - taxaGateway; // restante ap√≥s taxa
  
  const dadosEvento = {
    orderId, // üéØ USA O MESMO ORDERID DO EVENTO PENDENTE
    platform: "VisionPay",
    paymentMethod: "pix",
    status: "paid",
    createdAt: agora.toISOString().replace('T', ' ').substring(0, 19),
    approvedDate: agora.toISOString().replace('T', ' ').substring(0, 19),
    refundedAt: null,
    customer: {
      name: nome || "Cliente",
      email: email || "cliente@exemplo.com",
      phone: phone,
      document: null,
      country: "MZ",
      ip: "102.0.0.1"
    },
    products: [{
      id: "lifeboost-secrets",
      name: "LifeBoost Secrets",
      planId: null,
      planName: null,
      quantity: 1,
      priceInCents: valorUSD
    }],
    trackingParameters: {
      utm_source: utm_source || null,
      utm_campaign: utm_campaign || null,
      utm_medium: utm_medium || null,
      utm_content: utm_content || null,
      utm_term: utm_term || null,
      src: null,
      sck: null
    },
    commission: {
      totalPriceInCents: valorUSD,
      gatewayFeeInCents: taxaGateway, // 7% de taxa
      userCommissionInCents: comissaoUsuario, // 93% comiss√£o
      currency: "USD"
    },
    isTest: false
  };

  await enviarEventoUtmify(dadosEvento);

  // Atualizar status no Firebase
  const eventoRef = await db.collection('utmify_eventos')
    .where('orderId', '==', orderId)
    .get();

  if (!eventoRef.empty) {
    await eventoRef.docs[0].ref.update({
      status: 'paid',
      approved_at: agora,
    });
  }

  console.log(`üí± Convers√£o: ${valorMZN} MZN ‚Üí ${(valorUSD/100).toFixed(2)} USD`);
}

// Fun√ß√£o de recupera√ß√£o
async function enviarMensagemWhatsAppRecuperacao(telefone, nomeCliente = '') {
  try {
    const telefoneFormatado = telefone.startsWith('258') ? telefone : `258${telefone.replace(/^0/, '')}`;

    const mensagem = `‚ö†Ô∏è Ol√°${nomeCliente ? ' ' + nomeCliente : ''}! Parece que houve um erro na sua tentativa de pagamento‚Ä¶

Mas temos uma not√≠cia boa ü§ë

Conseguimos liberar um acesso especial: em vez de pagar 197 MZN, voc√™ pode acessar tudo por apenas **97 MZN** (por tempo limitado)!

üëâ Finalize aqui agora:
https://lifeboostsecrets.online/rec/
Se tiver d√∫vidas, √© s√≥ responder por aqui. Estamos te esperando!`;

    await axios.post(
      'https://api.z-api.io/instances/3E253C0E7BA3B028DAC01664B40E8DC7/token/557A2D63524922D69AE44772/send-text',
      {
        phone: telefoneFormatado,
        message: mensagem
      },
      {
        headers: {
          'Client-Token': 'F1850a1deea6b422c9fa8baf8407628c5S'
        }
      }
    );

    console.log('‚úÖ Mensagem de recupera√ß√£o enviada via WhatsApp');
  } catch (err) {
    console.error('‚ùå Erro ao enviar mensagem de recupera√ß√£o:', err.response?.data || err.message);
  }
}

// üëá Fun√ß√£o que salva as transa√ß√µes falhadas
async function salvarTransacaoFalhada({ phone, metodo, reference, erro }) {
  try {
    await db.collection("transacoes_falhadas_2").add({
      phone,
      metodo,
      reference,
      erro,
      status: "falhou",
      created_at: new Date(),
    });
    console.log(`‚ö†Ô∏è Transa√ß√£o falhada salva: ${erro}`);
  } catch (err) {
    console.error("‚ùå Erro ao salvar transa√ß√£o falhada:", err);
  }
}

async function salvarCompra({ nome, email, phone, whatsapp, metodo, amount, reference, utm_source, utm_medium, utm_campaign, utm_term, utm_content }) {
  const dados = {
    nome,
    email,
    phone,
    whatsapp: whatsapp || '',
    metodo,
    amount,
    reference,
    created_at: new Date(),
    utm: {
      source: utm_source || '',
      medium: utm_medium || '',
      campaign: utm_campaign || '',
      term: utm_term || '',
      content: utm_content || '',
    },
  };

  const docRef = await db.collection('compras_checkout2').add(dados);
  console.log(`‚úÖ Compra salva no Firebase com ID: ${docRef.id}`);
}

// Rota do pagamento - ATUALIZADA PARA RECEBER ORDERID
app.post('/api/pagar', async (req, res) => {
  const {
    phone, amount, reference, orderId, metodo, email, nome, pedido, whatsapp,
    utm_source, utm_medium, utm_campaign, utm_term, utm_content, fbc, fbp
  } = req.body;

  console.log('Request body:', req.body);
  console.log('üÜî OrderID recebido:', orderId);

  console.log('UTMs capturados:', {
    utm_source,
    utm_medium,
    utm_campaign,
    utm_term,
    utm_content
  });

  if (!phone || !amount || !reference || !metodo || !orderId) {
    return res.status(400).json({
      status: 'error',
      message: 'phone, amount, reference, orderId e metodo s√£o obrigat√≥rios',
    });
  }

  let walletId, token;
  if (metodo === 'mpesa') {
    walletId = process.env.MPESA_WALLET_ID;
    token = process.env.MPESA_TOKEN;
  } else if (metodo === 'emola') {
    walletId = process.env.EMOLA_WALLET_ID;
    token = process.env.EMOLA_TOKEN;
  } else {
    return res.status(400).json({
      status: 'error',
      message: 'M√©todo inv√°lido. Use mpesa ou emola.',
    });
  }

  const url = `https://e2payments.explicador.co.mz/v1/c2b/${metodo}-payment/${walletId}`;

  // üéØ ENVIAR EVENTO PENDENTE PARA UTMIFY COM ORDERID √öNICO
  try {
    await criarEventoPagamentoPendente({
      orderId, // üÜî USA O ORDERID DO CHECKOUT
      nome,
      email,
      phone,
      amount,
      utm_source,
      utm_medium,
      utm_campaign,
      utm_term,
      utm_content
    });
  } catch (err) {
    console.error('‚ùå Erro ao enviar evento pendente para Utmify:', err);
  }

  try {
    const response = await axios.post(
      url,
      {
        client_id: process.env.CLIENT_ID,
        amount: amount.toString(),
        phone,
        reference, // mant√©m o reference original para o gateway
      },
      {
        headers: {
          Authorization: `Bearer ${token}`,
          Accept: 'application/json',
          'Content-Type': 'application/json',
        },
      }
    );

    console.log('Resposta da API externa:', response.data);

    // üéØ ENVIAR EVENTO APROVADO PARA UTMIFY COM MESMO ORDERID
    try {
      await criarEventoPagamentoAprovado({
        orderId, // üÜî MESMO ORDERID DO EVENTO PENDENTE
        nome,
        email,
        phone,
        amount,
        utm_source,
        utm_medium,
        utm_campaign,
        utm_term,
        utm_content
      });
    } catch (err) {
      console.error('‚ùå Erro ao enviar evento aprovado para Utmify:', err);
    }

    const fbPixelId = process.env.FB_PIXEL_ID;
    const fbAccessToken = process.env.FB_ACCESS_TOKEN;

    if (fbPixelId && fbAccessToken && email && phone) {
      try {
        const payload = {
          data: [
            {
              event_name: 'Purchase',
              event_time: Math.floor(Date.now() / 1000),
              action_source: 'website',
              user_data: {
                em: email ? sha256(email.trim().toLowerCase()) : undefined,
                ph: phone ? sha256(phone.replace(/\D/g, '')) : undefined,
                fbp: fbp || undefined,
                fbc: fbc || undefined,
              },
              custom_data: {
                currency: 'MZN',
                value: amount,
              }
            }
          ],
          access_token: fbAccessToken,
          test_event_code: 'TEST10707'
        };

        const response = await axios.post(
          `https://graph.facebook.com/v19.0/${fbPixelId}/events`,
          payload
        );

        console.log('üéØ Evento de purchase enviado pro Facebook com sucesso!');
      } catch (fbErr) {
        console.error('‚ùå Erro ao enviar evento pro Facebook:', fbErr.response?.data || fbErr.message);
      }
    }

    // Enviar e-mail se tiver email
    const nomeCliente = nome || 'Cliente';

    if (email) {
      const textoEmailHTML = `
        <p>Ol√° ${nomeCliente}, seu pedido foi recebido com sucesso!</p>
        <p>Refer√™ncia: ${reference}. Valor: MZN ${amount}.</p>
        <p>Obrigado pela compra!</p>
        <p>Para acessar o produto, clique no link: 
        <a href="https://api.whatsapp.com/send/?phone=258865984978&text=Ol%C3%A1%2C+quero+receber+o+meu+acesso&type=phone_number&app_absent=0" target="_blank">Acessar produto</a></p>
      `;

      enviarEmail(email, 'Compra Confirmada!', textoEmailHTML);
    }

    // Adicionar na planilha
    try {
      await adicionarNaPlanilha({
        nome: nomeCliente,
        email,
        phone,
        metodo,
        amount,
        reference,
        utm_source,
        utm_medium,
        utm_campaign,
        utm_term,
        utm_content
      });
    } catch (err) {
      console.error('Erro ao adicionar dados na planilha:', err);
    }
    
    try {
      await salvarCompra({ nome: nomeCliente, email, phone, metodo, amount, reference, utm_source, utm_medium, utm_campaign, utm_term, utm_content });
    } catch (err) {
      console.error('‚ùå Erro ao salvar no Firebase:', err);
    }
    
    try {
      const userRef = db.collection('usuarios');
      const q = await userRef.where('telefone', '==', phone).get();

      if (q.empty) {
        await userRef.add({
          nome: nomeCliente,
          telefone: phone,
          saldo: 200,
          dataCadastro: new Date(),
        });
        console.log(`üì• Novo usu√°rio salvo em 'usuarios': ${nomeCliente}`);
      } else {
        console.log('üëÄ Usu√°rio j√° existe na cole√ß√£o "usuarios"');
      }
    } catch (err) {
      console.error('‚ùå Erro ao salvar usu√°rio em "usuarios":', err);
    }
    
    // Enviar WhatsApp via Z-API
    try {
      const telefoneFormatado = phone.startsWith('258')
        ? phone
        : `258${phone.replace(/^0/, '')}`;

      const mensagem = `Ol√° ${nomeCliente}! üëã\n\nSua transa√ß√£o foi aprovada com sucesso üõí\n\nüìå Refer√™ncia: *${reference}*\nüí∞ Valor: *MZN ${amount}*\n\nPara liberar o seu acesso √† plataforma, clique no bot√£o abaixo para enviar automaticamente a mensagem no nosso canal oficial com suporte via WhatsApp.\n‚úÖ Basta clicar em enviar e a Nat√°lia vai te acompanhar em todo o processo.\n\nhttps://wa.me/258858093864?text=Ol%C3%A1%2C%20quero%20receber%20o%20meu%20acesso `;

      await axios.post(
        'https://api.z-api.io/instances/3E253C0E919CB028543B1A5333D349DF/token/4909422EC4EB52D5FAFB7AB1/send-text',
        {
          phone: telefoneFormatado,
          message: mensagem,
        },
        {
          headers: {
            'Client-Token': 'F1850a1deea6b422c9fa8baf8407628c5S',
          },
        }
      );

      console.log('‚úÖ Mensagem enviada via WhatsApp (Z-API)');
      await notificarPushcut();
      await notificarPushcutSecundario();
    } catch (err) {
      console.error('‚ùå Erro ao enviar mensagem pelo WhatsApp:', err.response?.data || err.message);
    }

    res.json({ status: 'ok', data: response.data });
  } catch (err) {
    const erroDetalhado = err?.response?.data?.message || err.message || "Erro desconhecido";

    console.error('Erro na requisi√ß√£o externa:', erroDetalhado);

    // Salvar falha no Firestore
    await salvarTransacaoFalhada({
      phone,
      metodo,
      reference,
      erro: erroDetalhado
    });

    // ‚è±Ô∏è Agenda envio de mensagem de recupera√ß√£o
    setTimeout(() => {
      enviarMensagemWhatsAppRecuperacao(phone, nome);
    }, 2 * 60 * 1000);

    res.status(500).json({ status: 'error', message: erroDetalhado });
  }
});

app.listen(PORT, () => {
  console.log(`üöÄ Servidor rodando na porta ${PORT}`);
});
